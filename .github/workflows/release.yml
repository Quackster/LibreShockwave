name: Release

on:
  push:
    tags:
      - 'cast-extractor-*'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build fat JAR and Windows exe
        run: ./gradlew :sdk:build :cast-extractor:fatJar :cast-extractor:windowsExe

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          VERSION="${GITHUB_REF#refs/tags/cast-extractor-}"
          VERSION="${VERSION#v}"  # Strip leading 'v' if present
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create ZIP of Windows app
        shell: pwsh
        run: |
          Compress-Archive -Path "cast-extractor/build/exe/CastExtractor" -DestinationPath "cast-extractor/build/CastExtractor-${{ steps.get_version.outputs.VERSION }}-windows.zip"

      - name: Rename fat JAR for release
        shell: bash
        run: |
          cp cast-extractor/build/libs/cast-extractor-1.0.0-all.jar cast-extractor/build/CastExtractor-${{ steps.get_version.outputs.VERSION }}.jar

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: CastExtractor v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## CastExtractor v${{ steps.get_version.outputs.VERSION }}

            A GUI tool for extracting and previewing assets from Macromedia Director files (.dir, .dxr, .dcr, .cst, .cct).

            ### Downloads

            - **CastExtractor-${{ steps.get_version.outputs.VERSION }}.jar** - Cross-platform JAR (requires Java 21+)
            - **CastExtractor-${{ steps.get_version.outputs.VERSION }}-windows.zip** - Windows application (no Java required)

            ### Running the JAR
            ```bash
            java -jar CastExtractor-${{ steps.get_version.outputs.VERSION }}.jar
            ```

            ### Features
            - Browse and extract cast members (bitmaps, scripts, sounds, text)
            - Preview scripts with bytecode disassembly
            - Preview bitmaps with palette support
            - Play sounds (including MP3)
            - Score viewer
          files: |
            cast-extractor/build/CastExtractor-${{ steps.get_version.outputs.VERSION }}.jar
            cast-extractor/build/CastExtractor-${{ steps.get_version.outputs.VERSION }}-windows.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
