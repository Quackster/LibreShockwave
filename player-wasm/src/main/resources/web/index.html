<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibreShockwave Web Player</title>
    <link rel="stylesheet" href="libreshockwave.css">
</head>
<body>
    <div class="container">
        <h1>LibreShockwave</h1>

        <div class="controls">
            <div class="file-controls">
                <label class="file-label">
                    <input type="file" id="file-picker" accept=".dcr,.dir,.dxr,.cct,.cst">
                    Choose File
                </label>
                <span class="or">or</span>
                <input type="text" id="url-input" placeholder="Enter URL to .dcr/.dir file">
                <button id="load-url-btn">Load URL</button>
            </div>

            <div class="playback-controls">
                <button id="play-btn" disabled>Play</button>
                <button id="pause-btn" disabled>Pause</button>
                <button id="stop-btn" disabled>Stop</button>
                <span id="frame-info" class="frame-info"></span>
            </div>
        </div>

        <div class="stage-wrapper">
            <canvas id="shockwave-stage" width="640" height="480"></canvas>
        </div>

        <div id="status" class="status">Waiting for a movie file...</div>
    </div>

    <!-- TeaVM standard WASM runtime + player bridge -->
    <script src="player-wasm.wasm-runtime.js"></script>
    <script src="player-bridge.js"></script>
    <script>
        async function initPlayer() {
            var status = document.getElementById('status');
            var filePicker = document.getElementById('file-picker');
            var urlInput = document.getElementById('url-input');
            var loadUrlBtn = document.getElementById('load-url-btn');
            var playBtn = document.getElementById('play-btn');
            var pauseBtn = document.getElementById('pause-btn');
            var stopBtn = document.getElementById('stop-btn');
            var frameInfo = document.getElementById('frame-info');
            var canvas = document.getElementById('shockwave-stage');

            try {
                var player = new LibreShockwavePlayer();
                player.setCanvas(canvas);
                await player.init();
                status.textContent = 'Ready. Load a movie file to begin.';

                function enableControls() {
                    playBtn.disabled = false;
                    pauseBtn.disabled = false;
                    stopBtn.disabled = false;
                }

                function updateFrameInfo() {
                    var current = player.getCurrentFrame();
                    var total = player.getFrameCount();
                    if (total > 0) {
                        frameInfo.textContent = 'Frame ' + current + ' / ' + total;
                    }
                }

                // File picker handler
                filePicker.addEventListener('change', function(e) {
                    var file = e.target.files[0];
                    if (!file) return;

                    status.textContent = 'Loading ' + file.name + '...';
                    var reader = new FileReader();
                    reader.onload = function() {
                        var bytes = new Uint8Array(reader.result);
                        if (player.loadMovie(bytes, file.name)) {
                            status.textContent = 'Loaded: ' + file.name;
                            enableControls();
                            updateFrameInfo();
                        } else {
                            status.textContent = 'Error: failed to parse ' + file.name;
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });

                // URL loader handler
                loadUrlBtn.addEventListener('click', function() {
                    var url = urlInput.value.trim();
                    if (!url) return;

                    status.textContent = 'Fetching ' + url + '...';
                    fetch(url)
                        .then(function(r) {
                            if (!r.ok) throw new Error('HTTP ' + r.status);
                            return r.arrayBuffer();
                        })
                        .then(function(buf) {
                            var bytes = new Uint8Array(buf);
                            if (player.loadMovie(bytes, url)) {
                                status.textContent = 'Loaded from URL';
                                enableControls();
                                updateFrameInfo();
                            } else {
                                status.textContent = 'Error: failed to parse movie from URL';
                            }
                        })
                        .catch(function(err) {
                            status.textContent = 'Error: ' + err.message;
                        });
                });

                // Playback controls
                playBtn.addEventListener('click', function() {
                    player.play();
                    status.textContent = 'Playing';
                });

                pauseBtn.addEventListener('click', function() {
                    player.pause();
                    status.textContent = 'Paused';
                    updateFrameInfo();
                });

                stopBtn.addEventListener('click', function() {
                    player.stop();
                    status.textContent = 'Stopped';
                    updateFrameInfo();
                });

                // Periodic frame info update during playback
                setInterval(updateFrameInfo, 250);

            } catch (e) {
                status.textContent = 'Failed to initialize WASM: ' + e.message;
                console.error('TeaVM init error:', e);
            }
        }

        initPlayer();
    </script>
</body>
</html>
