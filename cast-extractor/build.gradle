plugins {
    id 'java'
    id 'application'
}

group = 'com.libreshockwave'
version = '1.0.0'

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}

repositories {
    mavenCentral()
}

dependencies {
    // LibreShockwave SDK
    implementation project(':sdk')

    // MP3 playback support
    implementation 'javazoom:jlayer:1.0.1'

    // MP3 SPI for AudioSystem integration
    implementation 'com.googlecode.soundlibs:mp3spi:1.9.5.4'
}

application {
    mainClass = 'com.libreshockwave.tools.CastExtractorTool'
}

jar {
    manifest {
        attributes(
            'Main-Class': 'com.libreshockwave.tools.CastExtractorTool',
            'Class-Path': configurations.runtimeClasspath.collect { it.name }.join(' ')
        )
    }
}

// Create a fat JAR with all dependencies
tasks.register('fatJar', Jar) {
    archiveClassifier = 'all'
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE

    manifest {
        attributes 'Main-Class': 'com.libreshockwave.tools.CastExtractorTool'
    }

    // Declare inputs to establish proper task dependencies
    inputs.files(configurations.runtimeClasspath)

    from sourceSets.main.output
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
}

// Create Windows executable using jpackage (requires JDK 14+)
// Usage: gradlew :cast-extractor:windowsExe
tasks.register('windowsExe') {
    dependsOn fatJar

    def fatJarFile = tasks.fatJar.archiveFile
    def outputDir = layout.buildDirectory.dir('exe')

    inputs.file(fatJarFile)
    outputs.dir(outputDir)

    doLast {
        def javaHome = System.getProperty('java.home')
        def jpackageExe = new File(javaHome, 'bin/jpackage.exe')
        if (!jpackageExe.exists()) {
            jpackageExe = new File(javaHome, 'bin/jpackage')
        }

        def jarFile = fatJarFile.get().asFile
        def outDir = outputDir.get().asFile

        // Ensure output directory exists
        outDir.mkdirs()

        // Clean previous output (may fail if files are locked by running process)
        def existingDir = new File(outDir, 'CastExtractor')
        if (existingDir.exists()) {
            try {
                project.delete(existingDir)
            } catch (Exception e) {
                println "Warning: Could not delete existing directory (files may be in use): ${e.message}"
            }
        }

        // Run jpackage
        def command = [
            jpackageExe.absolutePath,
            '--type', 'app-image',
            '--name', 'CastExtractor',
            '--input', jarFile.parentFile.absolutePath,
            '--main-jar', jarFile.name,
            '--main-class', 'com.libreshockwave.tools.CastExtractorTool',
            '--dest', outDir.absolutePath,
            '--add-modules', 'java.base,java.desktop,java.prefs,java.logging,jdk.unsupported',
            '--java-options', '-Xmx4g'
        ]

        println "Running: ${command.join(' ')}"

        def process = new ProcessBuilder(command)
            .redirectErrorStream(true)
            .start()

        process.inputStream.eachLine { println it }

        def exitCode = process.waitFor()
        if (exitCode != 0) {
            throw new GradleException("jpackage failed with exit code ${exitCode}")
        }

        println "Windows executable created at: ${outDir}/CastExtractor/CastExtractor.exe"
    }
}
